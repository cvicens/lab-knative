---
## Install

# Deploy Kafka using an operator
- name: Create a Subscription of the kafka operator
  k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: "{{ kafka_subsription_name }}"
        namespace: "{{ all_namespaces_project_name }}"
      spec:
        channel: "{{ kafka_subsription_channel }}"
        installPlanApproval: "{{ kafka_subsription_install_plan_approval }}"
        name: "{{ kafka_subsription_name }}"
        source: "{{ kafka_subsription_source }}"
        sourceNamespace: "{{ kafka_subsription_source_namespace }}"
        startingCSV: "{{ kafka_subsription_starting_csv }}"

# Approve install plan for kafka operator
## Find the plan
- name: wait for kafka csv to be ready
  shell: "oc get installplan -o json -n {{ all_namespaces_project_name }} | jq -r '.items[] | select(.spec.clusterServiceVersionNames[]? | contains(\"{{ knative_kafka_subsription_csv_root }}\")) | .metadata.name'"
  register: result
  until: (result.stdout|length > 0)
  retries: 6
  delay: 15

- set_fact:
    kafka_installplan: "{{ result.stdout }}"

## Approve the plan
- name: patch kafka install plan
  shell: "oc patch installplan/{{ kafka_installplan }} -n {{ all_namespaces_project_name }} --type='json' -p='[{\"op\": \"add\", \"path\": \"/spec/approved\", \"value\":true}]'"
  register: result
  until: (result.stdout|length > 0)

# Checking status of the operator
- name: wait for kafka csv to be ready
  shell: "oc get csv -o json -n {{ all_namespaces_project_name }} | jq -r '.items[] | select(.metadata.name | contains(\"{{ kafka_subsription_csv_root }}\")) | .status.phase'"
  register: result
  until: result.stdout.find("Succeeded") != -1
  retries: 30
  delay: 30
